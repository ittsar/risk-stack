import React, { useEffect, useMemo, useState } from 'react';
import { apiRequest } from '../api/client';
import { useAuth } from '../context/AuthContext';

const statusOptions = [
    { value: 'open', label: 'Open' },
    { value: 'in_review', label: 'In Review' },
    { value: 'mitigating', label: 'Mitigating' },
    { value: 'accepted', label: 'Accepted' },
    { value: 'closed', label: 'Closed' },
];

const severityOptions = [
    { value: 'critical', label: 'Critical' },
    { value: 'high', label: 'High' },
    { value: 'medium', label: 'Medium' },
    { value: 'low', label: 'Low' },
    { value: 'informational', label: 'Informational' },
];

const initialState = {
    reference_id: '',
    title: '',
    description: '',
    status: 'open',
    severity: 'medium',
    cve_id: '',
    cvss_score: '',
    cvss_vector: '',
    published_date: '',
    control_ids: [],
    risk_ids: [],
};

const VulnerabilityForm = ({
    mode = 'create',
    vulnerability = null,
    onSuccess,
    onCancel,
    isCollapsed,
    setIsCollapsed,
}) => {
    const { token } = useAuth();
    const [formData, setFormData] = useState(initialState);
    const [controls, setControls] = useState([]);
    const [risks, setRisks] = useState([]);
    const [loadingReferences, setLoadingReferences] = useState(false);
    const [error, setError] = useState(null);
    const [isSubmitting, setIsSubmitting] = useState(false);

    const collapsed = typeof isCollapsed === 'boolean' ? isCollapsed : false;
    const heading =
        mode === 'edit' && vulnerability
            ? `Edit Vulnerability - ${vulnerability.reference_id}`
            : mode === 'edit'
            ? 'Edit Vulnerability'
            : 'Create New Vulnerability';

    const toggleLabel = collapsed
        ? mode === 'edit'
            ? 'Expand editor'
            : 'New vulnerability'
        : 'Collapse editor';

    useEffect(() => {
        if (!token) {
            return;
        }

        const loadReferences = async () => {
            try {
                setLoadingReferences(true);
                const [controlResp, riskResp] = await Promise.all([
                    apiRequest('/api/controls/', { token }),
                    apiRequest('/api/risks/', { token }),
                ]);
                setControls(controlResp.results ?? controlResp ?? []);
                setRisks(riskResp.results ?? riskResp ?? []);
            } catch (err) {
                setError('Failed to load reference data.');
            } finally {
                setLoadingReferences(false);
            }
        };

        loadReferences();
    }, [token]);

    useEffect(() => {
        if (mode === 'edit' && vulnerability) {
            setFormData({
                reference_id: vulnerability.reference_id || '',
                title: vulnerability.title || '',
                description: vulnerability.description || '',
                status: vulnerability.status || 'open',
                severity: vulnerability.severity || 'medium',
                cve_id: vulnerability.cve_id || '',
                cvss_score: vulnerability.cvss_score != null ? String(vulnerability.cvss_score) : '',
                cvss_vector: vulnerability.cvss_vector || '',
                published_date: vulnerability.published_date || '',
                control_ids: (vulnerability.controls || []).map((item) => item.id),
                risk_ids: (vulnerability.risks || []).map((item) => item.id),
            });
        } else {
            setFormData(initialState);
        }
    }, [mode, vulnerability]);

    const handleToggleCollapsed = () => {
        setIsCollapsed?.(!collapsed);
    };

    const handleFieldChange = (event) => {
        const { name, value } = event.target;
        setFormData((prev) => ({ ...prev, [name]: value }));
    };

    const handleMultiChange = (name, value) => {
        setFormData((prev) => ({ ...prev, [name]: value }));
    };

    const handleSubmit = async (event) => {
        event.preventDefault();
        if (!token) return;

        setIsSubmitting(true);
        setError(null);

        const payload = {
            ...formData,
            cvss_score: formData.cvss_score === '' ? null : Number(formData.cvss_score),
            published_date: formData.published_date || null,
        };

        try {
            if (mode === 'edit' && vulnerability) {
                await apiRequest(`/api/vulnerabilities/${vulnerability.id}/`, {
                    method: 'PATCH',
                    token,
                    body: payload,
                });
                onSuccess?.();
                onCancel?.();
            } else {
                await apiRequest('/api/vulnerabilities/', {
                    method: 'POST',
                    token,
                    body: payload,
                });
                setFormData(initialState);
                onSuccess?.();
                setIsCollapsed?.(true);
            }
        } catch (err) {
            setError('Failed to save vulnerability. Check the form and try again.');
        } finally {
            setIsSubmitting(false);
        }
    };

    const controlOptions = useMemo(() => controls ?? [], [controls]);
    const riskOptions = useMemo(() => risks ?? [], [risks]);

    return (
        <div className="card" style={{ marginBottom: '24px' }}>
            <div className="card-header">
                <h2>{heading}</h2>
                <button type="button" onClick={handleToggleCollapsed}>
                    {toggleLabel}
                </button>
            </div>

            {!collapsed && (
                <form className="form-grid" onSubmit={handleSubmit}>
                    <div className="grid-two-columns" style={{ gap: '16px' }}>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="reference_id">Reference ID</label>
                            <input
                                id="reference_id"
                                name="reference_id"
                                value={formData.reference_id}
                                onChange={handleFieldChange}
                                required
                            />
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="title">Title</label>
                            <input id="title" name="title" value={formData.title} onChange={handleFieldChange} required />
                        </div>
                    </div>

                    <div style={{ display: 'grid', gap: '8px' }}>
                        <label htmlFor="description">Description</label>
                        <textarea
                            id="description"
                            name="description"
                            rows={3}
                            value={formData.description}
                            onChange={handleFieldChange}
                        />
                    </div>

                    <div className="grid-three-columns" style={{ gap: '16px' }}>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="status">Status</label>
                            <select id="status" name="status" value={formData.status} onChange={handleFieldChange}>
                                {statusOptions.map((option) => (
                                    <option key={option.value} value={option.value}>
                                        {option.label}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="severity">Severity</label>
                            <select id="severity" name="severity" value={formData.severity} onChange={handleFieldChange}>
                                {severityOptions.map((option) => (
                                    <option key={option.value} value={option.value}>
                                        {option.label}
                                    </option>
                                ))}
                            </select>
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="published_date">Published Date</label>
                            <input
                                type="date"
                                id="published_date"
                                name="published_date"
                                value={formData.published_date}
                                onChange={handleFieldChange}
                            />
                        </div>
                    </div>

                    <div className="grid-three-columns" style={{ gap: '16px' }}>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="cve_id">CVE ID</label>
                            <input id="cve_id" name="cve_id" value={formData.cve_id} onChange={handleFieldChange} />
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="cvss_score">CVSS Score</label>
                            <input
                                id="cvss_score"
                                name="cvss_score"
                                type="number"
                                step="0.1"
                                min="0"
                                max="10"
                                value={formData.cvss_score}
                                onChange={handleFieldChange}
                            />
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label htmlFor="cvss_vector">CVSS Vector</label>
                            <input id="cvss_vector" name="cvss_vector" value={formData.cvss_vector} onChange={handleFieldChange} />
                        </div>
                    </div>

                    <div className="grid-two-columns" style={{ gap: '24px' }}>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label>Associated Controls</label>
                            <MultiCheckbox
                                options={controlOptions}
                                selected={formData.control_ids}
                                onChange={(value) => handleMultiChange('control_ids', value)}
                                labelKey="reference_id"
                                helperText={loadingReferences ? 'Loading controls...' : undefined}
                            />
                        </div>
                        <div style={{ display: 'grid', gap: '8px' }}>
                            <label>Associated Risks</label>
                            <MultiCheckbox
                                options={riskOptions}
                                selected={formData.risk_ids}
                                onChange={(value) => handleMultiChange('risk_ids', value)}
                                labelKey="title"
                                helperText={loadingReferences ? 'Loading risks...' : undefined}
                            />
                        </div>
                    </div>

                    {error && <p style={{ color: '#dc2626', margin: 0 }}>{error}</p>}

                    <div style={{ display: 'flex', gap: '12px' }}>
                        <button type="submit" disabled={isSubmitting}>
                            {isSubmitting ? 'Saving...' : mode === 'edit' ? 'Save changes' : 'Create vulnerability'}
                        </button>
                        {mode === 'edit' && onCancel ? (
                            <button type="button" onClick={onCancel}>
                                Cancel
                            </button>
                        ) : null}
                    </div>
                </form>
            )}
        </div>
    );
};

const MultiCheckbox = ({ options, selected, onChange, labelKey = 'name', helperText }) => {
    const toggle = (value) => {
        if (selected.includes(value)) {
            onChange(selected.filter((item) => item !== value));
        } else {
            onChange([...selected, value]);
        }
    };

    if (!options || options.length === 0) {
        return <p style={{ color: '#64748b' }}>{helperText || 'No options available yet.'}</p>;
    }

    return (
        <div style={{
            border: '1px solid #cbd5f5',
            borderRadius: '6px',
            maxHeight: '240px',
            overflowY: 'auto',
            padding: '12px',
            display: 'grid',
            gap: '8px',
        }}>
            {options.map((option) => (
                <label key={option.id} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <input type="checkbox" checked={selected.includes(option.id)} onChange={() => toggle(option.id)} />
                    <span>
                        {option[labelKey] || option.name || option.reference_id}
                        {labelKey === 'reference_id' && option.name ? ` - ${option.name}` : ''}
                        {labelKey === 'title' && option.severity_label ? ` (${option.severity_label})` : ''}
                    </span>
                </label>
            ))}
        </div>
    );
};

export default VulnerabilityForm;


